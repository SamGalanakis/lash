<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lash Architecture</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@500;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --font-head: "Syne", "Avenir Next", sans-serif;
      --font-mono: "IBM Plex Mono", "SFMono-Regular", Consolas, monospace;

      --bg: #f2fbf8;
      --bg2: #e4f4ee;
      --surface: #fcfffe;
      --surface-2: #eef8f4;
      --text: #153329;
      --text-dim: #597368;
      --border: rgba(21, 51, 41, 0.13);
      --border-strong: rgba(21, 51, 41, 0.22);
      --primary: #0e8f66;
      --primary-dim: rgba(14, 143, 102, 0.12);
      --accent: #2a6fdd;
      --accent-dim: rgba(42, 111, 221, 0.10);
      --warn: #b0670d;
      --warn-dim: rgba(176, 103, 13, 0.12);
      --ink: #103126;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0d1713;
        --bg2: #12221c;
        --surface: #162922;
        --surface-2: #1d322a;
        --text: #dcf2ea;
        --text-dim: #9dbdb2;
        --border: rgba(220, 242, 234, 0.12);
        --border-strong: rgba(220, 242, 234, 0.2);
        --primary: #4ad5a7;
        --primary-dim: rgba(74, 213, 167, 0.15);
        --accent: #76b8ff;
        --accent-dim: rgba(118, 184, 255, 0.14);
        --warn: #f0bb70;
        --warn-dim: rgba(240, 187, 112, 0.16);
        --ink: #e6f8f1;
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      padding: 30px 16px 50px;
      color: var(--text);
      font-family: var(--font-mono);
      background:
        radial-gradient(900px 380px at 5% -4%, var(--primary-dim), transparent 62%),
        radial-gradient(740px 320px at 98% 103%, var(--accent-dim), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
    }

    .wrap {
      max-width: 1160px;
      margin: 0 auto;
      min-width: 0;
    }

    .hero {
      border: 1px solid var(--border-strong);
      border-radius: 20px;
      padding: 26px;
      background: color-mix(in srgb, var(--surface) 92%, transparent);
      box-shadow: 0 14px 40px rgba(0,0,0,.10);
      animation: fadeUp .44s ease-out both;
    }

    .hero h1 {
      font-family: var(--font-head);
      font-size: clamp(2.1rem, 4.2vw, 3rem);
      line-height: 1.02;
      letter-spacing: -.02em;
      margin-bottom: 10px;
      text-wrap: balance;
    }

    .hero p {
      color: var(--text-dim);
      font-size: 12px;
      line-height: 1.7;
    }

    .kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 16px;
    }

    .kpi {
      min-width: 0;
      border: 1px solid var(--border);
      border-radius: 11px;
      background: var(--surface-2);
      padding: 10px 12px;
    }

    .kpi .k {
      font-size: 10px;
      letter-spacing: .11em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .kpi .v {
      font-family: var(--font-head);
      font-size: 1.35rem;
      line-height: 1;
    }

    .grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      min-width: 0;
    }

    .card {
      min-width: 0;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--surface);
      padding: 16px;
      animation: fadeUp .44s ease-out both;
      animation-delay: calc(var(--i, 0) * .05s);
    }

    .card.hero-card {
      border-color: color-mix(in srgb, var(--primary) 50%, var(--border) 50%);
      background: color-mix(in srgb, var(--surface) 90%, var(--primary-dim));
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing: .08em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      color: var(--text-dim);
      background: var(--surface-2);
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: currentColor;
    }

    .title {
      font-family: var(--font-head);
      font-size: 1.35rem;
      letter-spacing: -.01em;
      margin-bottom: 8px;
      color: var(--ink);
    }

    .desc {
      font-size: 12px;
      line-height: 1.6;
      color: var(--text-dim);
      margin-bottom: 10px;
      overflow-wrap: break-word;
    }

    .inner {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      min-width: 0;
    }

    .inner.two { grid-template-columns: repeat(2, minmax(0, 1fr)); }

    .cell {
      min-width: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface-2);
      padding: 10px;
    }

    .cell h4 {
      font-size: 11px;
      margin-bottom: 5px;
      color: var(--ink);
    }

    .cell p {
      font-size: 11px;
      line-height: 1.55;
      color: var(--text-dim);
      overflow-wrap: break-word;
    }

    .flow {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 16px;
      min-width: 0;
    }

    .lane {
      border: 1px dashed var(--border-strong);
      border-radius: 14px;
      padding: 12px;
      background: color-mix(in srgb, var(--surface) 88%, transparent);
    }

    .lane h3 {
      font-family: var(--font-head);
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .steps {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 8px;
      min-width: 0;
      align-items: stretch;
    }

    .step {
      min-width: 0;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--surface-2);
      padding: 8px;
      font-size: 10px;
      line-height: 1.55;
      position: relative;
    }

    .step strong { color: var(--ink); display: block; margin-bottom: 3px; font-size: 10px; }

    .step:not(:last-child)::after {
      content: "";
      position: absolute;
      right: -7px;
      top: calc(50% - 6px);
      width: 12px;
      height: 12px;
      border-top: 2px solid var(--border-strong);
      border-right: 2px solid var(--border-strong);
      transform: rotate(45deg);
      background: transparent;
      z-index: 2;
    }

    code {
      font-family: var(--font-mono);
      background: var(--primary-dim);
      color: var(--primary);
      border: 1px solid color-mix(in srgb, var(--primary) 34%, transparent);
      border-radius: 5px;
      padding: 1px 5px;
      font-size: 10px;
      word-break: break-word;
    }

    .legend {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 10px;
      color: var(--text-dim);
      background: var(--surface-2);
    }

    .pill b { color: var(--ink); font-weight: 600; }

    .note {
      margin-top: 14px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, var(--warn-dim) 60%, var(--surface));
      border-radius: 11px;
      padding: 10px;
      font-size: 11px;
      line-height: 1.65;
      color: var(--text-dim);
    }

    .refs {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--surface);
      padding: 14px;
    }

    .refs h3 {
      font-family: var(--font-head);
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .ref-list {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      min-width: 0;
    }

    .ref {
      border: 1px solid var(--border);
      border-radius: 9px;
      background: var(--surface-2);
      padding: 8px;
      font-size: 10px;
      color: var(--text-dim);
      overflow-wrap: break-word;
    }

    .ref b { color: var(--ink); display: block; margin-bottom: 3px; }

    @media (max-width: 980px) {
      .kpis { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .inner, .inner.two { grid-template-columns: 1fr; }
      .steps { grid-template-columns: 1fr; }
      .step:not(:last-child)::after { display: none; }
      .ref-list { grid-template-columns: 1fr; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>lash Runtime Architecture</h1>
      <p>
        End-to-end map of how interactive TUI and headless/embedded frontends flow through the unified
        runtime input interface, agent loop, Python REPL bridge, tool system, and provider-backed model execution.
      </p>
      <div class="kpis">
        <article class="kpi"><div class="k">Entry Surfaces</div><div class="v">3</div></article>
        <article class="kpi"><div class="k">Core Layers</div><div class="v">6</div></article>
        <article class="kpi"><div class="k">Tool Discovery</div><div class="v">Injected + Dynamic</div></article>
        <article class="kpi"><div class="k">State Model</div><div class="v">Envelope + Snapshot</div></article>
      </div>
    </section>

    <section class="grid">
      <article class="card hero-card" style="--i:1">
        <div class="tag" style="color:var(--primary)"><span class="dot"></span>Inputs</div>
        <h2 class="title">Frontend Entry Points</h2>
        <p class="desc">
          `lash-cli` parses editor text into ordered input items (`text`, `file_ref`, `dir_ref`, `image_ref`, `skill_ref`).
          Headless mode (`--print`) uses the same runtime engine. Third-party hosts can send the same `TurnInput` envelope.
        </p>
        <div class="inner">
          <div class="cell">
            <h4>TUI</h4>
            <p>Slash commands, image paste markers, file/path references.</p>
          </div>
          <div class="cell">
            <h4>Headless</h4>
            <p>Single autonomous run with printed final output.</p>
          </div>
          <div class="cell">
            <h4>Embedded Host</h4>
            <p>Programmatic `RuntimeEngine::run_turn` with structured items.</p>
          </div>
        </div>
      </article>

      <article class="card" style="--i:2">
        <div class="tag" style="color:var(--accent)"><span class="dot"></span>Normalization</div>
        <h2 class="title">Runtime Item Normalization</h2>
        <p class="desc">
          Runtime validates references, canonicalizes paths, binds image blobs by id, and preserves ordered interleaving.
          This is the host/agent contract boundary.
        </p>
        <div class="inner two">
          <div class="cell">
            <h4>Contract</h4>
            <p><code>TurnInput { items[], image_blobs{} }</code> -> normalized text/image stream.</p>
          </div>
          <div class="cell">
            <h4>Validation</h4>
            <p>Missing image ids and invalid paths fail early with runtime error events.</p>
          </div>
        </div>
      </article>

      <article class="card" style="--i:3">
        <div class="tag" style="color:var(--warn)"><span class="dot"></span>Agent Core</div>
        <h2 class="title">Prompt Assembly + Iterative Loop</h2>
        <p class="desc">
          Agent resolves provider/model, refreshes tokens, builds client registry, injects only tools with
          <code>inject_into_prompt=true</code>, and appends discovery guidance for omitted tools
          (<code>list_tools</code>/<code>find_tools</code>, <code>T.&lt;tool&gt;</code>).
        </p>
        <div class="inner">
          <div class="cell">
            <h4>Prompt Tooling</h4>
            <p>Visible tools split into prompt-injected subset + discoverable runtime subset.</p>
          </div>
          <div class="cell">
            <h4>Context Control</h4>
            <p>Rolling window + `_history` / `_mem` for long-running sessions and sub-agents.</p>
          </div>
          <div class="cell">
            <h4>Mode Support</h4>
            <p>Normal + plan-mode behavior with optional plan-file handoff.</p>
          </div>
        </div>
      </article>

      <article class="card" style="--i:4">
        <div class="tag" style="color:var(--primary)"><span class="dot"></span>Execution Bridge</div>
        <h2 class="title">Session + Embedded Python REPL</h2>
        <p class="desc">
          Session spins up embedded Python, registers tool definitions, and executes code blocks in a persistent namespace.
          Tool invocations pass through Rust/Python bridge (`invoke_tool`) and can execute concurrently.
        </p>
        <div class="inner two">
          <div class="cell">
            <h4>Bidirectional Signals</h4>
            <p>Message streaming, final responses, tool-call records, image attachments, and prompt requests.</p>
          </div>
          <div class="cell">
            <h4>State Durability</h4>
            <p>Runtime keeps agent envelope + optional REPL snapshot blob for restore/resume.</p>
          </div>
        </div>
      </article>

      <article class="card" style="--i:5">
        <div class="tag" style="color:var(--accent)"><span class="dot"></span>Tools + Delegation</div>
        <h2 class="title">Composite Tool Graph</h2>
        <p class="desc">
          Base tools (file/shell/search/tasks/plan) are composed, then skill tools and `agent_call` are layered on top.
          Sub-agent tiers map to provider-specific model defaults.
        </p>
        <div class="inner">
          <div class="cell">
            <h4>Core Tools</h4>
            <p><code>read_file</code>, <code>edit_file</code>, <code>shell</code>, <code>glob</code>, <code>grep</code>, tasks, plan.</p>
          </div>
          <div class="cell">
            <h4>Optional</h4>
            <p>Web search/fetch when Tavily key exists; skill store from user/local skill dirs.</p>
          </div>
          <div class="cell">
            <h4>Delegation</h4>
            <p><code>agent_call</code> for low/medium/high tier sub-agents with shared working tree.</p>
          </div>
        </div>
      </article>

      <article class="card" style="--i:6">
        <div class="tag" style="color:var(--warn)"><span class="dot"></span>Persistence</div>
        <h2 class="title">Store, Logs, and Session State</h2>
        <p class="desc">
          SQLite-backed store tracks tasks/context artifacts for the session, while CLI keeps session logs and runtime
          state envelope that can be restored on resume.
        </p>
        <div class="inner two">
          <div class="cell">
            <h4>Store</h4>
            <p>Session-specific DB under <code>~/.lash/sessions/*.db</code>.</p>
          </div>
          <div class="cell">
            <h4>Envelope</h4>
            <p><code>AgentStateEnvelope</code>: messages, iteration, token usage, task/subagent state, snapshot.</p>
          </div>
        </div>
      </article>
    </section>

    <section class="flow">
      <article class="lane">
        <h3>Primary Dataflow</h3>
        <div class="steps">
          <div class="step"><strong>1. Host Input</strong>Frontend emits ordered `TurnInput.items` + optional image blobs.</div>
          <div class="step"><strong>2. Normalize</strong>Runtime validates refs and builds text/image stream for user message parts.</div>
          <div class="step"><strong>3. Agent Step</strong>Prompt assembled with provider config + injected tool docs + omission note.</div>
          <div class="step"><strong>4. REPL Exec</strong>Python executes code blocks; bridge dispatches tool calls through Rust.</div>
          <div class="step"><strong>5. Output</strong>Events stream back; final answer + updated envelope returned to host.</div>
        </div>
      </article>

      <div class="legend">
        <span class="pill"><b>Prompt-visible</b> <code>inject_into_prompt=true</code></span>
        <span class="pill"><b>Discoverable</b> <code>list_tools</code> / <code>find_tools</code> / <code>T.&lt;tool&gt;</code></span>
        <span class="pill"><b>Unified Items</b> <code>text + refs + image + skill</code></span>
      </div>

      <div class="note">
        Architecture constraint: sub-agents share the same filesystem/worktree. Parallel branches should avoid editing the same files concurrently.
      </div>
    </section>

    <section class="refs">
      <h3>Key Source Files</h3>
      <div class="ref-list">
        <div class="ref"><b>CLI Wiring</b><code>lash-cli/src/main.rs</code></div>
        <div class="ref"><b>Runtime API</b><code>lash/src/runtime.rs</code></div>
        <div class="ref"><b>Agent Loop</b><code>lash/src/agent/mod.rs</code></div>
        <div class="ref"><b>Session Bridge</b><code>lash/src/session.rs</code></div>
        <div class="ref"><b>Embedded Python</b><code>lash/src/embedded.rs</code> + <code>lash/python/repl.py</code></div>
        <div class="ref"><b>Tool Model</b><code>lash/src/lib.rs</code> + <code>lash/src/tools/*</code></div>
      </div>
    </section>
  </main>
</body>
</html>
