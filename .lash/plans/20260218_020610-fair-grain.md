# Plan: Migrate code block delimiters from markdown fences to XML tags

## Motivation

Triple-backtick fences can't nest. When the LLM writes a string containing triple backticks, the parser sees it as the closing fence and truncates the code block. XML tags solve this -- Python/Rust code never contains `</code>`.

## Design

**New protocol:**
- Opening: `<code>` (on its own line, trimmed)
- Closing: `</code>` (on its own line, trimmed)
- Feedback uses `<code>`, `<output>`, `<error>` tags
- Non-executable code examples in prose use standard markdown fences (unchanged)
- Breaking change -- old sessions will not parse correctly

## Files to Change

### 1. `lash/src/agent/message.rs` -- Serialization + deserialization

**`to_chat_msg()` (lines 76-91) -- serialization:**
- `PartKind::Code`: `<code>\n{}\n</code>`
- `PartKind::Output`: `<output>\n{}\n</output>`
- `PartKind::Error`: `<error>\n{}\n</error>`
- Same in the Assistant branch (line 91): Code -> `<code>\n{}\n</code>`

**`parse_markdown_sections()` (lines 196-272) -- system message deserialization:**
- Rename to `parse_sections`
- `<code>` opens code block, `</code>` closes it
- `<output>` opens output block, `</output>` closes it
- `<error>` opens error block, `</error>` closes it
- Prose stops at any of these opening tags

**`parse_assistant_sections()` (lines 275-332) -- assistant message deserialization:**
- Opening: `trimmed == "<code>"`
- Closing: `trimmed == "</code>"`
- Prose break condition: `next_trimmed == "<code>"`

### 2. `lash/src/agent/mod.rs` -- Streaming parser

**Opening detection (lines 598-602):**
- Replace 5-way check (`trimmed == triple-backtick-python` etc.) with `trimmed == "<code>"`

**Closing detection (line 625):**
- Replace `trimmed == triple-backtick` with `trimmed == "</code>"`

**No other changes needed** -- `in_code_fence`, unclosed block handling, and trailing prose detection all use the same boolean and don't reference the delimiter.

### 3. `lash/baml_src/agent.baml` -- Prompt templates

**`OrientReadAct()` (lines 28-31):** Change example from fenced to `<code>` tags
**`HashlineGuide()` (lines 37-52):** Update code examples
**`FindReplaceGuide()` (lines 58-62):** Update code examples
**`ShellGuide()` (lines 72-102):** Update code examples
**`CodeActStep` (lines 222-242):** Update 'How the Loop Works':
  - 'prose and `<code>` blocks' instead of 'prose and triple-backtick python code blocks'
  - Update example to use `<code>`/`</code>`
  - Remove the `py` vs `python` language tag rule (line 251)
  - Update `done()` instruction to reference `<code>` block
**`SubAgentStep` (lines 355-384):** Same changes as CodeActStep

### 4. No changes needed
- `lash-cli/src/session_log.rs` -- events are JSON, code already extracted
- `lash-cli/src/app.rs` -- receives structured AgentEvent, not raw text
- `lash-cli/src/markdown.rs` -- renders prose markdown only

## Execution Order

1. `message.rs` -- serialization (to_chat_msg)
2. `message.rs` -- deserialization (parse functions)
3. `agent/mod.rs` -- streaming parser
4. `agent.baml` -- prompt templates
5. Build + test
